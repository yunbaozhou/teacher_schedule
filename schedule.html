<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程表生成工具</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .course-card {
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 12px;
        }
        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .file-upload {
            border: 2px dashed #cbd5e1;
            transition: all 0.2s ease;
        }
        .file-upload:hover {
            border-color: #94a3b8;
        }
        .file-upload.active {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        .color-picker:hover {
            border-color: #6366f1;
        }
        .selected-color {
            border: 2px solid #000;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .table-cell {
            min-height: 60px;
            cursor: pointer;
        }
        .table-cell:hover {
            background-color: #f0f9ff;
        }
        .time-period {
            background-color: #e2e8f0;
            font-weight: bold;
            text-align: center;
        }
        .notes-text {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .timetable-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: none;
            background: transparent;
            width: 100%;
        }
        .timetable-title:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">课程表生成工具</h1>
            <p class="text-gray-600">快速创建并导出个性化课程表</p>
        </div>

        <!-- 课程表区域 -->
        <div class="glassmorphism p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-indigo-500"></i>课程表
                </h2>
                <div class="flex space-x-2">
                    <button id="export-image" class="bg-pink-600 text-white py-1 px-3 rounded-md text-sm hover:bg-pink-700 transition-colors">
                        <i class="fas fa-file-image mr-1"></i>图片
                    </button>
                    <button id="export-excel" class="bg-green-600 text-white py-1 px-3 rounded-md text-sm hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-1"></i>Excel
                    </button>
                    <button id="export-word" class="bg-blue-600 text-white py-1 px-3 rounded-md text-sm hover:bg-blue-700 transition-colors">
                        <i class="fas fa-file-word mr-1"></i>Word
                    </button>
                    <button id="print-schedule" class="bg-purple-600 text-white py-1 px-3 rounded-md text-sm hover:bg-purple-700 transition-colors">
                        <i class="fas fa-print mr-1"></i>打印
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse" id="course-table">
                    <thead>
                        <!-- 课表标题行 -->
                        <tr>
                            <th colspan="8" class="py-2 bg-gray-100 border border-gray-200">
                                <input type="text" id="timetable-title" class="timetable-title" placeholder="请输入课表名称（例如：初一(1)班课程表）">
                            </th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <th class="w-24 py-2 bg-gray-100 border border-gray-200">节次/星期</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期一</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期二</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期三</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期四</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期五</th>
                             <th class="py-2 bg-gray-100 border border-gray-200">星期六</th>
                            <th class="py-2 bg-gray-100 border border-gray-200">星期天</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 上午 -->
                        <tr>
                            <td colspan="8" class="time-period py-2 bg-gray-200 border border-gray-300">上午</td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第1节</td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="1" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第2节</td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="2" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第3节</td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="3" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第4节</td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="4" data-day="周日"></td>
                        </tr>
                        
                        <!-- 下午 -->
                        <tr>
                            <td colspan="8" class="time-period py-2 bg-gray-200 border border-gray-300">下午</td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第5节</td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="5" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第6节</td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="6" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第7节</td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="7" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第8节</td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="8" data-day="周日"></td>
                        </tr>
                        
                        <!-- 晚自习 -->
                        <tr>
                            <td colspan="8" class="time-period py-2 bg-gray-200 border border-gray-300">晚自习</td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第9节</td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="9" data-day="周日"></td>
                        </tr>
                        <tr>
                            <td class="py-3 text-center bg-gray-50 border border-gray-200">第10节</td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周一"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周二"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周三"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周四"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周五"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周六"></td>
                            <td class="border border-gray-200 table-cell" data-period="10" data-day="周日"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 冲突信息显示区域 -->
            <div id="conflict-alert" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg">
                <h3 class="font-bold">检测到冲突：</h3>
                <ul id="conflict-list" class="list-disc pl-5 mt-2"></ul>
            </div>
        </div>
    </div>

    <!-- 课程编辑模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">添加课程</h3>
                <span class="close-modal cursor-pointer text-2xl">&times;</span>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="edit-course-index">
                <input type="hidden" id="edit-mode"> <!-- "add" or "edit" -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">课程名称</label>
                    <input id="edit-course-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">星期</label>
                        <select id="edit-course-day" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="周一">星期一</option>
                            <option value="周二">星期二</option>
                            <option value="周三">星期三</option>
                            <option value="周四">星期四</option>
                            <option value="周五">星期五</option>
                            <option value="周六">星期六</option>
                            <option value="周日">星期日</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">节次</label>
                        <select id="edit-course-period" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="1">第1节</option>
                            <option value="2">第2节</option>
                            <option value="3">第3节</option>
                            <option value="4">第4节</option>
                            <option value="5">第5节</option>
                            <option value="6">第6节</option>
                            <option value="7">第7节</option>
                            <option value="8">第8节</option>
                            <option value="9">第9节</option>
                            <option value="10">第10节</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">教师</label>
                    <input id="edit-course-teacher" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">地点</label>
                    <input id="edit-course-location" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-course-notes">
                        备注
                    </label>
                    <input type="text" id="edit-course-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        时间段（可选）
                    </label>
                    <div class="flex items-center space-x-2">
                        <select id="edit-course-start-time" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">选择开始时间</option>
                        </select>
                        <span>~</span>
                        <select id="edit-course-end-time" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">选择结束时间</option>
                        </select>
                    </div>
                    <p class="text-gray-500 text-xs mt-1">时间段以5分钟为最小单位（可选，不填则不显示）</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        课程颜色
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <div class="color-picker bg-pink-200" data-color="255,204,204"></div>
                        <div class="color-picker bg-blue-200" data-color="204,255,255"></div>
                        <div class="color-picker bg-green-200" data-color="204,255,204"></div>
                        <div class="color-picker bg-yellow-200" data-color="255,255,153"></div>
                        <div class="color-picker bg-purple-200" data-color="221,170,221"></div>
                        <div class="color-picker bg-orange-200" data-color="255,179,136"></div>
                        <div class="color-picker bg-amber-200" data-color="255,229,153"></div>
                        <div class="color-picker bg-emerald-200" data-color="204,255,204"></div>
                        <input id="custom-color" type="color" class="w-10 h-8 cursor-pointer">
                    </div>
                    <input type="hidden" id="selected-color">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="delete-course-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">删除</button>
                    <button id="save-course-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">保存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-100 py-4 text-center text-gray-600 text-sm">
        <p>created by <a href="https://space.coze.cn" class="text-indigo-600 hover:underline">coze space</a></p>
        <p>页面内容均由 AI 生成，仅供参考</p>
    </footer>

    <script>
        // 全局变量存储课程数据
        let courseData = [];
        let userSelectedColors = {};
        
        // 生成时间选项（5分钟为间隔）
        function generateTimeOptions() {
            const startSelect = document.getElementById('edit-course-start-time');
            const endSelect = document.getElementById('edit-course-end-time');
            
            // 清空现有选项
            startSelect.innerHTML = '<option value="">选择开始时间</option>';
            endSelect.innerHTML = '<option value="">选择结束时间</option>';
            
            // 生成时间选项（从早上6点到晚上10点）
            for (let hour = 6; hour <= 22; hour++) {
                for (let minute = 0; minute < 60; minute += 5) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const option1 = document.createElement('option');
                    option1.value = timeString;
                    option1.textContent = timeString;
                    
                    const option2 = document.createElement('option');
                    option2.value = timeString;
                    option2.textContent = timeString;
                    
                    startSelect.appendChild(option1);
                    endSelect.appendChild(option2);
                }
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化颜色选择器
            initColorPickers();
            
            // 生成时间选项
            generateTimeOptions();
            
            // 绑定事件
            document.getElementById('export-image').addEventListener('click', exportToImage);
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            document.getElementById('export-word').addEventListener('click', exportToWord);
            document.getElementById('print-schedule').addEventListener('click', printSchedule);
            
            // 模态框事件
            document.querySelector('.close-modal').addEventListener('click', closeModal);
            document.getElementById('save-course-btn').addEventListener('click', saveCourse);
            document.getElementById('delete-course-btn').addEventListener('click', deleteCourse);
            
            // 为表格单元格添加点击事件
            document.querySelectorAll('.table-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    // 防止点击课程卡片时触发
                    if (e.target.classList.contains('course-card')) return;
                    
                    const period = this.getAttribute('data-period');
                    const day = this.getAttribute('data-day');
                    openAddModal(day, period);
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('edit-modal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        });
        
        // 初始化颜色选择器
        function initColorPickers() {
            // 预定义颜色选择
            document.querySelectorAll('.color-picker').forEach(picker => {
                picker.addEventListener('click', function() {
                    // 移除所有选中状态
                    document.querySelectorAll('.color-picker').forEach(p => {
                        p.classList.remove('selected-color');
                    });
                    
                    // 添加选中状态到当前元素
                    this.classList.add('selected-color');
                    
                    // 保存选中的颜色
                    document.getElementById('selected-color').value = this.getAttribute('data-color');
                });
            });
            
            // 自定义颜色选择器
            document.getElementById('custom-color').addEventListener('change', function() {
                // 移除所有预定义颜色的选中状态
                document.querySelectorAll('.color-picker').forEach(p => {
                    p.classList.remove('selected-color');
                });
                
                // 获取选择的颜色并转换为RGB
                const color = this.value;
                const r = parseInt(color.substr(1, 2), 16);
                const g = parseInt(color.substr(3, 2), 16);
                const b = parseInt(color.substr(5, 2), 16);
                
                document.getElementById('selected-color').value = `${r},${g},${b}`;
            });
        }
        
        // 打开添加课程模态框
        function openAddModal(day, period) {
            // 设置模态框标题
            document.getElementById('modal-title').textContent = '添加课程';
            
            // 设置隐藏字段
            document.getElementById('edit-mode').value = 'add';
            document.getElementById('edit-course-index').value = '';
            
            // 填充默认值
            document.getElementById('edit-course-day').value = day;
            document.getElementById('edit-course-period').value = period;
            document.getElementById('edit-course-name').value = '';
            document.getElementById('edit-course-teacher').value = '';
            document.getElementById('edit-course-location').value = '';
            document.getElementById('edit-course-notes').value = '';
            document.getElementById('edit-course-start-time').value = '';
            document.getElementById('edit-course-end-time').value = '';
            document.getElementById('selected-color').value = '';
            
            // 隐藏删除按钮
            document.getElementById('delete-course-btn').classList.add('hidden');
            
            // 移除所有颜色选择器的选中状态
            document.querySelectorAll('.color-picker').forEach(p => {
                p.classList.remove('selected-color');
            });
            document.getElementById('custom-color').value = '#000000';
            
            // 显示模态框
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // 打开编辑课程模态框
        function openEditModal(index) {
            const course = courseData[index];
            
            // 设置模态框标题
            document.getElementById('modal-title').textContent = '编辑课程';
            
            // 设置隐藏字段
            document.getElementById('edit-mode').value = 'edit';
            document.getElementById('edit-course-index').value = index;
            
            // 填充课程数据
            document.getElementById('edit-course-name').value = course.课程名称;
            document.getElementById('edit-course-day').value = course.星期;
            document.getElementById('edit-course-period').value = course.节次;
            document.getElementById('edit-course-teacher').value = course.教师;
            document.getElementById('edit-course-location').value = course.地点;
            document.getElementById('edit-course-notes').value = course.备注 || '';
            
            // 处理时间段数据
            if (course.时间) {
                const timeParts = course.时间.split('~');
                if (timeParts.length === 2) {
                    document.getElementById('edit-course-start-time').value = timeParts[0];
                    document.getElementById('edit-course-end-time').value = timeParts[1];
                } else {
                    document.getElementById('edit-course-start-time').value = '';
                    document.getElementById('edit-course-end-time').value = '';
                }
            } else {
                document.getElementById('edit-course-start-time').value = '';
                document.getElementById('edit-course-end-time').value = '';
            }
            
            // 显示删除按钮
            document.getElementById('delete-course-btn').classList.remove('hidden');
            
            // 显示模态框
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }
        
        // 保存课程（添加或编辑）
        function saveCourse() {
            const mode = document.getElementById('edit-mode').value;
            const courseName = document.getElementById('edit-course-name').value;
            const courseDay = document.getElementById('edit-course-day').value;
            const coursePeriod = parseInt(document.getElementById('edit-course-period').value);
            const courseTeacher = document.getElementById('edit-course-teacher').value;
            const courseLocation = document.getElementById('edit-course-location').value;
            const courseNotes = document.getElementById('edit-course-notes').value;
            const startTime = document.getElementById('edit-course-start-time').value;
            const endTime = document.getElementById('edit-course-end-time').value;
            const selectedColor = document.getElementById('selected-color').value;
            
            if (!courseName) {
                alert('请输入课程名称');
                return;
            }
            
            // 检查是否有时间冲突
            let excludeIndex = -1;
            if (mode === 'edit') {
                excludeIndex = parseInt(document.getElementById('edit-course-index').value);
            }
            
            const conflict = checkTimeConflict(courseDay, coursePeriod, excludeIndex);
            if (conflict) {
                alert('警告：该时间段已有课程安排！\\n' + conflict);
                return;
            }
            
            // 构建时间字符串
            let courseTime = '';
            if (startTime && endTime) {
                courseTime = `${startTime}~${endTime}`;
            }
            
            if (mode === 'add') {
                // 创建课程对象
                const course = {
                    "课程名称": courseName,
                    "教师": courseTeacher || '未指定',
                    "星期": courseDay,
                    "节次": coursePeriod,
                    "地点": courseLocation || '未指定',
                    "备注": courseNotes || '',
                    "时间": courseTime || ''
                };
                
                // 添加到课程数据中
                courseData.push(course);
                
                // 如果用户选择了颜色，则保存到用户选择的颜色映射中
                if (selectedColor) {
                    userSelectedColors[courseName] = selectedColor.split(',').map(Number);
                }
            } else {
                // 编辑模式
                const index = parseInt(document.getElementById('edit-course-index').value);
                
                // 更新课程数据
                courseData[index] = {
                    "课程名称": courseName,
                    "教师": courseTeacher || '未指定',
                    "星期": courseDay,
                    "节次": coursePeriod,
                    "地点": courseLocation || '未指定',
                    "备注": courseNotes || '',
                    "时间": courseTime || ''
                };
                
                // 如果课程名称改变，需要更新颜色映射
                if (courseData[index].课程名称 !== courseName) {
                    // 这里可以处理颜色映射的更新，如果有需要的话
                }
            }
            
            // 关闭模态框
            closeModal();
            
            // 更新表格显示
            updateCourseTable();
            
            // 检查冲突
            checkConflicts();
        }
        
        // 删除课程
        function deleteCourse() {
            if (confirm('确定要删除这个课程吗？')) {
                const index = parseInt(document.getElementById('edit-course-index').value);
                courseData.splice(index, 1);
                
                // 关闭模态框
                closeModal();
                
                // 更新表格显示
                updateCourseTable();
                
                // 检查冲突
                checkConflicts();
            }
        }
        
        // 检查时间冲突
        function checkTimeConflict(day, period, excludeIndex = -1) {
            for (let i = 0; i < courseData.length; i++) {
                if (i === excludeIndex) continue;
                if (courseData[i].星期 === day && courseData[i].节次 === period) {
                    return `课程：${courseData[i].课程名称} 教师：${courseData[i].教师}`;
                }
            }
            return null;
        }
        
        // 更新课程表显示
        function updateCourseTable() {
            // 清空所有单元格
            document.querySelectorAll('#course-table tbody td[data-period]').forEach(cell => {
                cell.innerHTML = '';
            });
            
            // 填充课程数据
            courseData.forEach((course, index) => {
                const cell = document.querySelector(`#course-table tbody td[data-period="${course.节次}"][data-day="${course.星期}"]`);
                if (cell) {
                    // 创建课程卡片
                    const card = document.createElement('div');
                    card.className = 'course-card p-2 m-1 rounded-md';
                    
                    // 构建卡片内容，只显示存在的信息
                    let cardContent = `<div class="font-bold text-lg">${course.课程名称}</div>`;
                    
                    // 只有当教师信息存在且不为"未指定"时才显示
                    if (course.教师 && course.教师 !== '未指定') {
                        cardContent += `<div class="text-xs">教师：${course.教师}</div>`;
                    }
                    
                    // 只有当地点信息存在且不为"未指定"时才显示
                    if (course.地点 && course.地点 !== '未指定') {
                        cardContent += `<div class="text-xs">地点：${course.地点}</div>`;
                    }
                    
                    // 只有当时间段信息存在时才显示
                    if (course.时间) {
                        cardContent += `<div class="text-xs font-medium text-blue-700">时间：${course.时间}</div>`;
                    }
                    
                    // 只有当备注信息存在时才显示
                    if (course.备注) {
                        cardContent += `<div class="notes-text">备注：${course.备注}</div>`;
                    }
                    
                    card.innerHTML = cardContent;
                    card.dataset.index = index;
                    
                    // 应用颜色
                    const color = getCourseColor(course.课程名称);
                    card.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                    
                    // 添加点击事件
                    card.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        openEditModal(index);
                    });
                    
                    cell.appendChild(card);
                }
            });
        }
        
        // 获取课程颜色
        function getCourseColor(courseName) {
            // 预定义颜色映射
            const colorMap = {
                "语文": [255, 204, 204],
                "数学": [204, 255, 255],
                "英语": [204, 255, 204],
                "综研": [229, 229, 204],
                "趣味体育": [255, 255, 153],
                "体育": [153, 204, 255],
                "音乐": [221, 170, 221],
                "体育与健康": [153, 204, 255],
                "道法": [204, 153, 204],
                "美术": [255, 179, 136],
                "科学": [255, 229, 153],
                "劳动": [204, 255, 204]
            };
            
            // 额外的默认颜色
            const defaultColors = [
                [255, 192, 203], [173, 216, 230], [144, 238, 144], [255, 182, 193],
                [221, 160, 221], [175, 238, 238], [255, 218, 185], [240, 230, 140],
                [230, 230, 250], [255, 228, 196]
            ];
            
            // 如果用户选择了颜色，则优先使用用户选择的颜色
            if (userSelectedColors[courseName]) {
                return userSelectedColors[courseName];
            }
            
            // 如果预定义了颜色，则使用预定义颜色
            if (colorMap[courseName]) {
                return colorMap[courseName];
            }
            
            // 如果都没有，则从默认颜色中自动分配
            const courseHash = Math.abs(courseName.split('').reduce((a,b) => (((a << 5) - a) + b.charCodeAt(0))|0, 0)) % defaultColors.length;
            return defaultColors[courseHash];
        }
        
        // 检查冲突
        function checkConflicts() {
            // 发送请求到后端检查冲突
            fetch('/api/courses/conflicts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({courses: courseData})
            })
            .then(response => response.json())
            .then(data => {
                const conflicts = data.conflicts;
                
                // 显示冲突信息
                const conflictAlert = document.getElementById('conflict-alert');
                const conflictList = document.getElementById('conflict-list');
                
                if (conflicts.length > 0) {
                    conflictList.innerHTML = '';
                    conflicts.forEach(conflict => {
                        const li = document.createElement('li');
                        li.textContent = conflict;
                        conflictList.appendChild(li);
                    });
                    conflictAlert.classList.remove('hidden');
                } else {
                    conflictAlert.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('检查冲突时出错:', error);
            });
        }
        
        // 导出到Excel
        function exportToExcel() {
            if (courseData.length === 0) {
                alert('请先添加课程数据');
                return;
            }
            
            // 获取课表标题
            const timetableTitle = document.getElementById('timetable-title').value || '课程表';
            
            // 发送请求到后端生成Excel文件
            fetch('/api/export/excel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    courses: courseData,
                    title: timetableTitle
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('导出失败');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = timetableTitle + '.xlsx';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('导出Excel时出错:', error);
                alert('导出Excel失败: ' + error.message);
            });
        }
        
        // 导出到Word
        function exportToWord() {
            if (courseData.length === 0) {
                alert('请先添加课程数据');
                return;
            }
            
            // 获取课表标题
            const timetableTitle = document.getElementById('timetable-title').value || '课程表';
            
            // 发送请求到后端生成Word文件
            fetch('/api/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    courses: courseData,
                    userSelectedColors: userSelectedColors,
                    title: timetableTitle
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('导出失败');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = timetableTitle + '.docx';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('导出Word时出错:', error);
                alert('导出Word失败: ' + error.message);
            });
        }
        
        // 导出到图片
        function exportToImage() {
            if (courseData.length === 0) {
                alert('请先添加课程数据');
                return;
            }
            
            // 显示加载状态
            const originalText = document.getElementById('export-image').innerHTML;
            document.getElementById('export-image').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>导出中...';
            document.getElementById('export-image').disabled = true;
            
            // 获取课表标题
            const timetableTitle = document.getElementById('timetable-title').value || '课程表';
            
            // 克隆表格以避免影响原始表格
            const table = document.getElementById('course-table');
            const tableClone = table.cloneNode(true);
            
            // 调整克隆表格的样式以解决显示问题
            tableClone.style.fontSize = '14px';
            tableClone.style.width = '100%';
            tableClone.style.tableLayout = 'fixed'; // 固定表格布局防止内容溢出
            
            // 调整表格单元格样式实现垂直居中
            const tableCells = tableClone.querySelectorAll('td, th');
            tableCells.forEach(cell => {
                cell.style.display = 'table-cell';
                cell.style.verticalAlign = 'middle'; // 垂直居中
            });
            
            // 调整课程卡片样式
            const courseCards = tableClone.querySelectorAll('.course-card');
            courseCards.forEach(card => {
                // 减小课程名称的上边距
                const courseName = card.querySelector('.font-bold');
                if (courseName) {
                    courseName.style.marginTop = '0';
                    courseName.style.paddingTop = '0';
                }
                
                // 确保卡片内容完整显示且不超出单元格
                card.style.padding = '2px';
                card.style.margin = '1px';
                card.style.height = 'auto';
                card.style.wordWrap = 'break-word'; // 自动换行防止内容溢出
                card.style.overflow = 'hidden'; // 防止内容溢出
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.justifyContent = 'center'; // 在Flex容器中垂直居中
            });
            
            // 创建一个临时容器来放置克隆的表格
            const tempContainer = document.createElement('div');
            tempContainer.style.padding = '20px';
            tempContainer.style.backgroundColor = '#f8fafc';
            tempContainer.style.width = table.offsetWidth + 'px'; // 设置容器宽度与原表格一致
            tempContainer.appendChild(tableClone);
            
            // 添加到页面中但隐藏起来
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '-9999px';
            document.body.appendChild(tempContainer);
            
            // 使用html2canvas将表格转换为图片
            html2canvas(tempContainer, {
                scale: 2, // 提高图片质量
                useCORS: true,
                backgroundColor: '#f8fafc',
                scrollY: -window.scrollY,
                windowHeight: tempContainer.scrollHeight + 100, // 增加额外高度确保内容完整显示
                width: tempContainer.scrollWidth, // 设置画布宽度
                height: tempContainer.scrollHeight // 设置画布高度
            }).then(canvas => {
                // 恢复按钮状态
                document.getElementById('export-image').innerHTML = originalText;
                document.getElementById('export-image').disabled = false;
                
                // 从页面中移除临时容器
                document.body.removeChild(tempContainer);
                
                // 将canvas转换为图片并下载
                const link = document.createElement('a');
                link.download = timetableTitle + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                // 恢复按钮状态
                document.getElementById('export-image').innerHTML = originalText;
                document.getElementById('export-image').disabled = false;
                
                // 从页面中移除临时容器
                document.body.removeChild(tempContainer);
                
                console.error('导出图片时出错:', error);
                alert('导出图片失败: ' + error.message);
            });
        }
        
        // 打印课程表
        function printSchedule() {
            // 获取课表标题
            const timetableTitle = document.getElementById('timetable-title').value || '课程表';
            
            // 创建打印窗口
            const printWindow = window.open('', '_blank');
            
            // 获取表格HTML并进行处理
            const table = document.getElementById('course-table').cloneNode(true);
            
            // 移除事件监听器相关的属性
            table.querySelectorAll('*').forEach(element => {
                element.removeAttribute('data-period');
                element.removeAttribute('data-day');
                element.removeAttribute('id');
            });
            
            // 复制课程卡片样式
            document.querySelectorAll('.course-card').forEach(card => {
                const cloneCard = card.cloneNode(true);
                const index = card.dataset.index;
                const originalCard = table.querySelector(`.course-card[data-index="${index}"]`);
                if (originalCard) {
                    originalCard.outerHTML = cloneCard.outerHTML;
                }
            });
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${timetableTitle}</title>
                        <style>
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                                margin: 20px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: center;
                                vertical-align: top;
                            }
                            thead th {
                                background-color: #f3f4f6;
                                font-weight: bold;
                                padding: 8px;
                            }
                            .time-period {
                                background-color: #e5e7eb;
                                font-weight: bold;
                                text-align: center;
                                padding: 8px;
                            }
                            .course-card {
                                font-size: 12px;
                                text-align: left;
                                padding: 8px;
                                margin: 2px;
                                border-radius: 6px;
                                color: #000;
                            }
                            .notes-text {
                                font-size: 10px;
                                opacity: 0.8;
                                margin-top: 4px;
                            }
                            h1 {
                                text-align: center;
                                font-size: 24px;
                                margin-bottom: 20px;
                            }
                            .table-header {
                                background-color: #f3f4f6;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${timetableTitle}</h1>
                        ${table.outerHTML}
                        <script>
                            window.onload = function() {
                                window.print();
                                window.onafterprint = function() {
                                    window.close();
                                }
                            }
                        <\/script>
                    </body>
                </html>
            `);
            
            printWindow.document.close();
        }

    </script>
</body>
</html>